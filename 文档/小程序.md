# 小程序

一般使用[uView](https://www.uviewui.com/components/intro.html)这个UI框架



## 下拉加载

在page.json中开启`"enablePullDownRefresh": true`，在需要开启下拉加载的页面使用`onReachBottom`函数判断用户是否触底，如果触底判断是否需要加载



展示列表



## 订阅消息

requestSubscribeMessage

```js
uni.requestSubscribeMessage({
  tmplIds: [''], // 公众号的模板消息id
  success (res) { }, // 成功回调
  fail (err) { } // 失败回调
})
```



## 打开另一个小程序

navigateToMiniProgram

```js
uni.navigateToMiniProgram({
  appId: '', // 跳转程序的appId
  path: '', // 跳转程序的路径
  extraData: { // 需要传递给目标小程序的数据
    'data1': 'test'
  },
  success(res) {
    // 打开成功
  }
})
```



## [获取微信用户信息](https://uniapp.dcloud.io/api/plugins/login?id=getuserprofile)

getUserProfile

```vue
<template>
	<u-button shape="square" type="primary" @click="getUserProfile"> 授权微信用户信息 </u-button>
</template>
<script>
export default{
  methods:{
    getUserProfile(){
      wx.getUserProfile({
        desc: '授权微信用户信息',
        success: async (res) => {
          if (res.errMsg === 'getUserProfile:ok') {
            console.log('授权成功')
          }
        },
        fail: () => {}
      })
    }
  }
}
</script>
```



## 获取电话号码

①调用uni.login获取wxCode

②调用后端接口获取sessionKey

③调用后端接口登录注册账号，将值存到vuex中(-1 ==> 初始化; 501 ==> 未注册; 502 ==> 已注册, 未人脸; 503 ==> 已注册, 已人脸)；如果要微警认证那么需要将返回的token也保存起来

```vue
<template>
<u-button open-type="getPhoneNumber" @getphonenumber="getPhoneNumber">授权手机号码</u-button>
</template>
<script>
export default{
  methods:{
    async getPhoneNumber(e: any) {
      const { encryptedData, iv } = e.detail
      // 取消授权 的处理
      if (!encryptedData && !iv) {
        return
      }
      this.$showLoading()
      try {
        // 小程序自带的登录接口
        const [{ code: wxCode }] = await uni.login({
          type: 'sync',
          provider: 'weixin'
        })
        // 获取sessionKey(后端接口)
        const {
          code, data, msg
        } = await loadCode({
          jsCode: wxCode
        })
        if (code == 200) {
          // 调用后端接口注册登录账号(更新vuex中的值，已经注册完成但是还没有进行人脸识别)
        } else {
          // 错误信息的提醒
        }
      } catch (err) {
        console.error('loadUserRegister -> ' + err)
      } finally {
        uni.hideLoading()
      }
    }
  }
}
</script>
```

**open-type 的合法值**

| 值             | 说明                                                         |
| :------------- | :----------------------------------------------------------- |
| contact        | 打开客服会话，如果用户在会话中点击消息卡片后返回小程序，可以从 bindcontact 回调中获得具体信息，[具体说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/customer-message/customer-message.html) （*小程序插件中不能使用*） |
| share          | 触发用户转发，使用前建议先阅读[使用指引](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/share.html#使用指引) |
| getPhoneNumber | 获取用户手机号，可以从bindgetphonenumber回调中获取到用户信息，[具体说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/getPhoneNumber.html) （*小程序插件中不能使用*） |
| getUserInfo    | 获取用户信息，可以从bindgetuserinfo回调中获取到用户信息 （*小程序插件中不能使用*） |
| launchApp      | 打开APP，可以通过app-parameter属性设定向APP传的参数[具体说明](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/launchApp.html) |
| openSetting    | 打开授权设置页                                               |
| feedback       | 打开“意见反馈”页面，用户可提交反馈内容并上传[日志](https://developers.weixin.qq.com/miniprogram/dev/api/base/debug/wx.getLogManager.html)，开发者可以登录[小程序管理后台](https://mp.weixin.qq.com/)后进入左侧菜单“客服反馈”页面获取到反馈内容 |



## 调整小程序进行另外操作

```vue
<template>
	<u-button open-type="getPhoneNumber" @getphonenumber="handleFaceAuth">人脸实名认证</u-button>
</template>
<script>
export default{
  methods:{
    async handleFaceAuth(e: any) {
      const { encryptedData, iv } = e.detail
      // 取消授权 的处理
      if (!encryptedData && !iv) {
        return
      }
      const certToken = await getStorageSync('CERTTOKEN') // 这个调用后端接口登录注册账号的token值
      uni.showModal({
        title: '提示',
        content: '您暂未注册，即将跳转人脸认证进行注册',
        showCancel: false, //是否显示取消按钮
        confirmText: '确定', //默认是“确定”
        confirmColor: '#3cc51f', //确定文字的颜色
        success: res => {
          if (res.cancel) {
            //点击取消
            return
          } else {
            uni.navigateToMiniProgram({// 跳转到人脸识别的小程序
              appId: '',
              path: '',
              extraData: { certToken },
              fail: () => { console.log('取消跳转') }
            })
          }
        },
        complete: function(res) {} // 一般用于取消loading
      })
    }
  }
}
</script>
```





## 登录

①调用uni.login获取wxCode

②调用后端接口检查用户是否存在

③调用后端接口登录注册账号，将值存到vuex中(-1 ==> 初始化; 501 ==> 未注册; 502 ==> 已注册, 未人脸; 503 ==> 已注册, 已人脸)；如果要微警认证那么需要将返回的token也保存起来

```js
// 微信小程序授权微信用户登录
const [ { code: wxCode }] = await uni.login({
  type: 'sync',
  provider: 'weixin'
})

// 授权微信用户后调用后端接口判断该用户是否已经存在数据库中
const { data: { code, data, wechatId } } = await loadHasUser({ jsCode: wxCode })
// 注册状态 -1 ==> 初始化; 501 ==> 未注册; 502 ==> 已注册, 未人脸; 503 ==> 已注册, 已人脸
```



## 下载图片到本地

```js
// 将远程文件下载到小程序中
const res = await uni.downloadFile({url: '向远程服务器地址下载图片路径'})
// 将图片下载到相册中
const res1 = uni.saveImageToPhotosAlbum({filePath: res[1].tempFilePaths})
```



## 案例

### calendar默认值

calendar设置日历的默认时间`activeDate`属性值

```js
this.$refs.calendar.activeDate = this.minDate
```

![](https://i.bmp.ovh/imgs/2021/10/d8596b511a32046e.png)

